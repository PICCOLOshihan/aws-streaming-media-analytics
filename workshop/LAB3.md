

# LAB 3: MEASURING AND REPORTING IN REAL TIME

In this lab you will deploy an application which performs sliding window analysis on the metrics generated by the video.js plugin in real time. During the lab you will explore how real-time analysis can be performed using Kinesis Video>. After performing the analysis, you will also explore how real-time metrics can be used to enhance the viewer experience through content suggestions and social enhancements.

## REAL-TIME SLIDING WINDOW ANALYSIS WITH KINESIS ANALYTICS
In this lab you will deploy a real-time analytics application using Kinesis Analytics. The application will analyze the player event data flowing through the Kinesis Data Firehose stream in real-time.

1. In the AWS Management Console, under Services, select Kinesis.

2. From the menu on the left, click on Data Analytics.

3. We have pre-configured a Kinesis Analytics application to monitor the player event stream. This application is deployed in a READY state. To start the application, select the mediaqos-qos-realtimeapp application from the list and under Actions select Run Application. When asked to confirm, click on the Run Application button again.

4. The application may take a couple of minutes to start. When the application has started, the State column will show the application as Running.

5. To begin exploring the output of the application, click on the Application details button. If you cannot see the button, click on the triangle icon located next to the Application name to reveal additional metadata about the application, including the Application details button.

6. The Application Details console provides an overview of the application configuration, showing the source, processing and destination stages. Take a moment to read through these to better understand the data flow.

7. To explore the SQL code that makes up the application, click on the Go to SQL Results button located under the Real time analytics section.

8. The Real-time analytics console shows the SQL statements which make up the streaming analytics application. You can explore the output of these statements in the bottom half of the console. To observe the flow of data, reload the video player application page (linked in the Outputs section of the CloudFormation stack) you have used in previous labs and start watching a long video (we suggest Big Buck Bunny). Once the video is playing, switch back to the Real-time analytics console.

9. While the video is playing, you can preview data at each stage of the application:

   1.  To view the data streaming in to the application: select the Source Data tab. If you do not immediately see sample data from the SOURCE_SQL_STREAM_001 stream displayed in table format, click on the Retrieve rows button to refresh the input data.

   2.  To view the data as it is processed: select the Real-time analytics tab. From here you can select each stream from the list and see the results as calculated by the related Kinesis Analytics SQL statement.

   - ACTIVE_USERS - the metric is calculated by aggregating unique users over a '2' minute sliding window. The corresponding SQL in the Kinesis Analytics application populating the stream is:
```sql
CREATE OR REPLACE PUMP "STREAM_PUMP4" AS
INSERT INTO "ACTIVE_USERS"
SELECT STREAM 'ACTIVE_USERS_1MIN', count(DISTINCT "user_id")
OVER SLIDING_WINDOW AS LAST_2MIN_SLIDING FROM "SOURCE_SQL_STREAM_001"
WHERE "MetricType" = 'STREAM'
WINDOW SLIDING_WINDOW AS
( PARTITION BY "MetricType" RANGE INTERVAL '2' MINUTE PRECEDING);
```
							
   - RECENT_VIEWS - the metric is calculated by aggregating unique video 'PLAY' event over a '2' minute sliding window. The corresponding SQL in the Kinesis Analytics application populating the stream is:

```sql
CREATE OR REPLACE PUMP "STREAM_PUMP1" AS INSERT INTO "RECENT_VIEWS"
SELECT STREAM "video_id", count(DISTINCT "user_id") OVER SLIDING_WINDOW FROM "SOURCE_SQL_STREAM_001"
WHERE "MetricType" = 'STREAM'
WINDOW SLIDING_WINDOW AS
( PARTITION BY "MetricType" RANGE INTERVAL '2' MINUTE PRECEDING);
```
   - AGGREGATE_VIEWS - the metric is calculated by counting the video 'PLAY' event that occured over a '1' minute interval. The corresponding SQL in the Kinesis Analytics application populating the stream is:

```sql
CREATE OR REPLACE PUMP STREAM_PUMP2 AS
INSERT INTO AGGREGATE_VIEWS SELECT STREAM "video_id", COUNT(1) FROM
( SELECT STREAM DISTINCT rowtime as window_time, "video_id","user_id",
STEP((SOURCE_SQL_STREAM_001.rowtime) BY INTERVAL '1' MINUTE) FROM
SOURCE_SQL_STREAM_001 WHERE "MetricType" = 'PLAY') as distinct_stream
GROUP BY "video_id",
STEP((distinct_stream.window_time) BY INTERVAL '1' MINUTE);
```				

Click on each stream and observe the data and how it changes as you play multiple videos in the video player application.

   10. To understand where the output of each stream is sent: select the Destination tab. From here you can find links to Lambda functions which are executed periodically with the output of ACTIVE_USERS, RECENT_VIEWS and AGGREGATE_VIEWS stream. 

    (Optional) You can explore the execution frequency and processing time for each lambda function by following the link to the Lambda console and viewing the CloudWatch metrics linked under the Monitoring tab for each function.

11. Now that you have observed the method used to extract and process real-time information from the player logs, the next step is to look at where this data is presented. In your browser, reload the OTT streaming application page. You can find the output of the Kinesis Analytics streams you have just observed in the following locations:

      1. The total/aggregate video views is made visible by expanding the Popular Videos (total views) section of the player user interface.

      2. The active users is made visible by expanding the Active Users section of the player user interface.

      3. The recent views for a video is what you see as #People watching while playing a video and is visible right next to the PLAY and PAUSE buttons in the video player

## PUBLISHING THE ANALYSIS RESULTS
In this section we will observe the flow of data from Kinesis Analytics through to the end-user application. As you observed in the previous section, data processed by Kinesis Analytics is delivered to Lambda for further processing.

The Lambda functions called by Kinesis Analytics update a central data store, hosted in Amazon DynamoDB. To update DynamoDB, the Lambda functions call mutations in AWS AppSync to perform this operation, rather than pushing directly to DynamoDB. By publishing updates through AppSync, we can also easily update client applications, such as the video player application this workshop focuses on, with results from the the Analytics stream without the need to have our clients constantly poll the DynamoDB table for updates.

Exploring DynamoDB

1. Open the DynamoDB Console by clicking on the Services button in the AWS Management Console and selecting DynamoDB from the list.

2. The DynamoDB console will list two tables which include the strings:

1. ActiveUserTable - This table holds the output of the ACTIVE_USERS Kinesis Analytics stream

2. VideoViewTable - This table holds the output of the RECENT_VIEWS & AGGREGATE_VIEWS Kinesis Analytics streams.

3. Select each table from the list to observe details of its configuration

4. Note that these tables are configured with the default read/write capacity of 5 units each. In a production implementation you may need to tune these values and consider adopting DynamoDB Auto-Scaling to support fluctuating load.

5. To view the contents of each table, select the Items tab to view the current contents. If you play some videos in the client application, periodically refresh this view to see the resulting output from Kinesis Analytics update the values in the tables.

Exploring Appsync

1. Open the AppSync Console by clicking on the Services button in the AWS Management Console and selecting AppSync from the list.

2. The AppSync console will display a list of APIs configured in the region. The default API name deployed for this workshop is mediaqos-qos-graphql.

3. An AppSync API is defined as a GraphQL schema. The schema defines the objects and interaction model available to clients. To explore the GraphQL Schema for our API, click on the Schema link in the menu on the left.

1. The schema defines two objects: Video and ActiveUser. These objects correspond to the DynamoDB tables we looked at in the last section.

2. Operations on these objects (ie DynamoDB Tables) are defined as Query (read) and Mutation (update) Types.

3. Clients can subscribe to monitor updates to the values of a Video via the Subscription Type.

4. To explore the way AppSync interacts with the data model, click on the Queries link in the menu on the left

5. To query the total views of the video named oceans, enter the following query into the Queries console and click the Play button to execute the query:

6. If the query runs successfully, you will see the result from the query in the column on the right. If you get a result of 'null', perhaps you haven't watched Oceans since starting the Kinesis Analytics application? Watch the video and then re-run the query.

7. Next, to observe how mutations work, lets add another video to the catalog. This action demonstrates how Lambda adds and updates values in DynamoDB using AppSync. To add a new entry, copy & paste the following query into the Queries console (be sure to comment out or remove your previous entry):

8. After running this query, return to the DynamoDB Management console. You will see a new entry in the VideoViewTable showing the values for the mytestvideo video.

9. In addition, you will now also see the entry for mytestvideo in the Popular Videos (total views) section of the end user application. You should not need to reload the page for this to appear, as the end user application subscribes to updates


## [PROCEED TO CLEANUP](CLEANUP.md)
You have now completed all of the lab work for this workshop. Well done! The next step is to clean up the resources created in your AWS account before you leave for the next session.

