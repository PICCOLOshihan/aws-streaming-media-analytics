
# LAB 2: EXPLORING THE DATA AND GENERATING REPORTS

In this lab you will learn how to build reports covering key metrics extracted from the log data generated by the video player application and the Content Distribution network. During this lab you will use Amazon QuickSight to visualize data, leveraging Amazon Athena and AWS Glue to perform queries on the data set that is stored in Amazon S3.

## PLAYER EVENT METRICS
At the conclusion of lab 1, we looked at the player log data written to S3. In this lab, we'll explore turning this data into visual reports that can be easily understood by various stakeholders in your business. The video player captures the following events in the S3 backed data lake:

* PLAY - When the user requests for a video to be played. The video.js plugin will capture the current playback time in addition to the video_id and user_id.
* PAUSE - When the user presses the pause button. The video.js plugin will capture the current position in addition to the video_id and user_id.
* FIRSTFRAME - This metric is computed as the time difference between two separate player events. The first event occurs when the player makes a request to the CDN and the second event occurs when the first data byte arrives. The time difference between these events is captured in this metric.
* BUFFER - This metric is computed based on two separate player events. The first event occurs when buffering is experienced by the player and viewer. The second event occurs when playback resumes. The time difference between these events is captured in this metric.
* SEEK - This occurs when the user moves the playback location elsewhere in the video. This metric captures the location from where the seek started and where the seek ended. Seeking may also result in buffering as the player requests additional fragments. This time is also captured in this metric.
* ERROR - This occurs when an unexpected error occurs in the video player. Details of the error from the player internals are captured along with the video_id.
* STOP - When video is stopped by user. The video.js plugin will capture the location where video was stopped in addition to the video_id and user_id.
* STREAM - This metric is captured periodically whenever the player makes a request to server. By parsing the request URL the plugin is able to extract the bitrate, resolution, frames per second (fps) and package type (whether HLS or MPEG-DASH) and also include this metadata along with the video_id.
The log data produced by the video player and CDN's access logs can be used in a variety of ways to better understand the user experience and the quality of service delivered to consumers of the video platform. In the next sections we will configure Amazon QuickSight to access the player and CDN logs and then build a number of reports covering operational metrics by combining data from both sets of information.

## CONFIGURING QUICKSIGHT AND ATHENA
During this lab you will use Amazon QuickSight to visualize reports. In turn, QuickSight will use Amazon Athena to query the raw player and CDN log data stored in the S3-backed data lake. Before you can get started generating reports, you will need to grant QuickSight permission to use Amazon Athena and to access the S3 bucket holding the log data.

It is likely that QuickSight is not currently enabled on the AWS Account you are using in this lab. To confirm this, navigate to the QuickSight service in the AWS Management Console and if you are asked to Sign Up for QuickSight, you are not currently enabled to use QuickSight. If this is the case, click the following link to expand instructions on how to set up QuickSight on your account.

1. If you are not already using QuickSight on your account, you will be prompted to Sign Up for QuickSight. Click on the blue Sign up for QuickSight button to start the sign up process.

2. Select the Standard Edition of QuickSight. The features provided by this edition are appropriate for the labs you will soon complete.

3. You will need to provide a name for your QuickSight subscription. This should be unique to you and descriptive of your use-case or organization. You will also need to provide a contact email address.

4. Ensure that the tick box next to Amazon Athena is checked to authorize QuickSight to use the Athena service.

5. Near the Amazon Athena option, you will also find a link to Choose S3 Buckets that QuickSight has access to. Follow this link and ensure the bucket named mediaqos-logs-{acctid}-{region} is ticked.

6. If you have selected the above options, you can now click through to set up QuickSight.

If you are already using QuickSight in your AWS account, click below to expand instructions on how to grant QuickSight access to Amazon Athena and the S3 Bucket hosting the data lake and log data.

1. To allow QuickSight and Athena to work with the log data stored in S3, you will need to ensure QuickSight has permission to access the S3 bucket the logs are stored in. To configure QuickSight permissions, you will need to be in US East (N. Virginia) region. Once you have switched to this region, click on your username located in the top right corner of the QuickSight Management Console. In the menu that appears, select Manage QuickSight.

2. From the menu on the left, click on Account settings.

3. Under Connected products & Services, click on the Add or remove button.

4. Ensure the following items are ticked:

1. Amazon Athena

2. Amazon S3

5. Click on the Choose S3 buckets link to select the buckets QuickSight can access.

6. From the menu that appears, under the 'S3 buckets linked to QuickSight account' tab, select the S3 bucket named mediaqos-logs-{acctid}-{region}.

7. Click Select buckets.

8. Click Update to grant QuickSight access to Amazon Athena and the S3 bucket the log data is stored in.

## WORK IN THE CORRECT REGION
Finally, before moving on, ensure that you are using QuickSight in the correct region for this lab. Ensure QuickSight is in the same region you deployed the CloudFormation template in during the pre-work. You can change the region by clicking on the location menu, located in the top right corner of the QuickSight Management Console.

## CREATING QUICKSIGHT DATA SETS FOR PLAYER AND CDN LOGS
The data pipeline created in your AWS account currently captures log data from the video player application, and the CDN (Amazon CloudFront). These logs are processed and stored in Amazon S3 and catalogued by Glue, allowing them to be accessed by Athena and QuickSight.

In this step, you will now create a QuickSight data set which links the player logs to the CDN logs, using a common field: the CloudFront generated x-amz-cf-id HTTP Header value. By linking the data sets together we can create richer reports on the user experience.

Joining data sets together like this is best performed as close to the ingest point as possible. In a production environment, we would recommend implementing this join as a part of your ETL process in a service such as AWS Glue. In todays workshop, instead of implementing this in Glue, we will walk you through creating a joined table in QuickSight. This method will allow you to quickly explore and determine the value in the joined data set.

In a production scenario, pushing this join further back in the data pipeline will improve the efficiency and cost of the solution by reducing the data volume queried by Amazon Athena and facilitating re-use of the joined data set in multiple applications.

Follow the steps below to perform a join operation in QuickSight, creating a new data set composed of columns from both the player and CDN logs:

1. Navigate to the dashboard page in QuickSight by clicking on the QuickSight logo in the top left corner of the console.

2. Click on the Manage data button located in the top right corner of the console

3. Click on the New data set button located in the top left corner of the console

4. Under the Create a Data Set FROM NEW DATA SOURCES section, located at the top of the screen, select Athena.

5. In the popup, under Data source name, enter mediaqos-joined and click on Create Data source.

6. In the next popup (Choose your table), expand the Database drop-down menu and select the Glue Database named mediaqos_qos_db.

7. You will see two tables listed. Select cdn_logs and click the Edit/Preview data button located in the bottom left corner.

8. In the data preview console, click the Add data link located located above the cdn_logs data set.

9. In the popup window, select player_logs from the list of tables and click the Select button to add this table to the data set.

10. Click on the two pink dots that are now shown joining the two tables together to configure the join between the tables.

11. In the Join configuration section, located at the bottom of the screen, select requestid from the drop down menu under cdn_logs and cdn_tracking_id from the drop down menu under player_logs.

12. Modify the Join Type, changing to a value of Right. This will result all player logs being reported on with any corresponding CDN information being appended.

13. Click the Apply button located at the bottom of the screen to create the join.

14. One of the fields in our dataset, timestamp, contains a unix timestamp which needs to be converted so it can be interpreted as a Date:

    i. Under the Fields menu on the left, click the Add calculated field button.

    ii. Select epochDate from the Function list and timestamp from the Field list

    iii. Enter "eventtime" in the Calculated field name

    iv. Validate that the Formula box is filled out with epochDate({timestamp}) and click Create.

15. Finally, modify the name of the data set, located at the top of the screen. Change the name from cdn_logs to joined_logs. Click the Save & visualize button to create the new joined data set and move to the next step.

## CREATING QUICKSIGHT REPORTS
Now that you have set up QuickSight, it's time to build some reports in QuickSight to analyze key operational metrics.

To make it easy to build each chart, we have provided verbose instructions for the first two charts, but shorter, abbreviated sets of instructions for the following charts.

In the interests of time, we have divided the 12 sample charts in this section into two groups. Please aim to complete the first group at a minimum, as this will introduce all the core concepts. If you are working quickly, we have provided an additional set of charts which you can also build out if time allows.

## SAMPLE CHARTS
Firstly, lets create some reports which are based on the event data generated by the video.js player:

### SUMMARY OF PLAYER EVENTS
This chart will show a breakdown of the events recorded by the video.js plugin. You can use this to understand the relative percentage of events generated by the video player.

1. QuickSight automatically creates a chart for us to start using when the analysis is created. This will be visible as a box with AutoGraph written in the middle. If this is not visible in the Analysis console, click the "+ Add" button located in the top left corner and select Add Visual to create a new chart.

2. For this chart we will use a Pie chart. Select the Pie chart chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. Ensure the Field wells menu is expanded. If it is, you will see a blue box labeled Group/Color and a green box labeled Value at the top of the QuickSight management console. If you cannot see these boxes, click on the double-arrow located on the top far right of the console in line with the Field wells header. You will use these boxes to control which fields are rendered in each chart.

4. In the Fields list menu on the left, click and drag metrictype on to the blue Group/Color box in the Field wells menu.

5. QuickSight will render a chart showing the count of records by metrictype. From this you can gain an insight into the relative count of each event type experienced by users of the streaming platform.

6. (optional) You can further customize the graph by clicking on the arrow in the top right corner of the graph and selecting Format visual to change the display of various components. You can also customize the title by double-clicking on this and modifying the text.

### AVERAGE BITRATE BY HOUR
This chart will show the average bitrate over time. You can use this chart to identify if there are periods in the day when users are viewing content at lower (or higher) quality than expected.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this graph type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    eventtime -> X axis

    avg_bitrate -> Value

    video_id -> Group/Color

4. Click on the drop-down menu arrow next to eventtime and change the Aggregate setting to Hour.

5. Click on the drop-down menu arrow next to avg_bitrate and change the Aggregate setting to Average.

6. QuickSight will now render a chart showing the average bitrate for each video played, organized in to 1 hour segments.

### MOST PLAYED VIDEOS
This chart shows the most popular videos. You can use this to identify trends in viewing behavior over time.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    eventtime -> X axis

    metrictype -> Value

    video_id -> Group/Color

4. Now, in this chart we are only interested in PLAY events. To limit the chart to only report on these events, click on the Filter menu icon located on the far left of the QuickSight management console.

5. Click the + icon next to Applied filters to create a new filter and select metrictype from the list of fields that appears.

6. Click on the metrictype filter that now appears in the Applied filters list and change the Filter type drop-down to Custom filter list. In the free text field that appears, type PLAY

7. Click the Apply button at the bottom of the Edit filter menu to create the filter, leaving all other values as default.

8. QuickSight will now render a chart showing the most played videos. The values for the chart correspond to the number of PLAY events recorded by the video player application.

### UNIQUE VIEWERS OF EACH VIDEO
This chart shows the unique viewers of each video. You can use this to dive in to your popular content and understand the distribution of viewers.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    video_id -> X axis

    user_id -> Value

    eventtime -> Group/Color

4. To limit the graph to unique users for each video, click on the drop-down menu arrow in the green Value box, located next to user_id, and change the Count setting to Count Distinct.

5. Quicksight will now render a chart showing a list of videos along the X axis and the number of unique viewers represented as the height of each bar in the chart.

In addition to capturing event logs from the video player application, our data pipeline also collects logs from the CDN (Amazon CloudFront). Follow the next instructions to generate some graphs based on CDN logs:

### BROWSER TYPES
This chart will show the browsers recorded viewing your content. The classification of browsers is performed by the CloudFront CDN. This can be useful for aligning your testing environment to match the platforms your users are using to view your content with.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Pie Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag browserfamily on to the blue Group/Color box.

4. QuickSight will now render a chart showing a break down of the different browser families that have viewed videos in the application.

5. If the chart shows a category of null, click on this section of the chart and select Exclude null from the menu that appears.

### CACHE HIT RATIO
This chart will show the events recorded by the CloudFront CDN. You can use this to determine your cache hit ratio, which for a production environment should be very high. For the limited testing you have performed in todays lab, a high MISS rate is expected. You can use this report to validate if your CDN configuration is optimized.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Pie Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag resulttype on to the blue Group/Color box.

4. QuickSight will now render a chart showing a break down of the CDN response types. You can use this graph to compare the Cache Hit and Miss percentages.

5. If the chart shows a category of null, click on this section of the chart and select Exclude null from the menu that appears.

Finally, it is possible to join the client side player logs and the server side CDN logs together using the unique identifier (x-amz-cf-id header) returned by the CDN with every HTTP response. This header is captured where possible in the player event logs allows us to link player events to HTTP requests recorded in the CDN logs. The following instructions demonstrate how you can report across the join between these two sources of log data:

### BUFFER EVENTS BY LOCATION
This chart joins the buffer events recorded by the video.js plugin, with edge location information recorded by the CloudFront CDN logs. You can use this chart to narrow down on the geographic location buffer events may be occurring in.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    location -> X axis

    buffer_type -> Value

    logdate -> Group/Color

4. Click on the Filter menu and then click on the + icon located next to the Applied Filters heading. From the drop-down menu select buffer_type to create a filter on buffering event types.

5. Click on the buffer_type filter that is now in the filter list and from the list of buffer types shown, tick the box next to ScreenFreezedBuffer.

    If QuickSight does not show ScreenFreezedBuffer as an available option to filter on, you can add it manually manually: modify the Filter type drop-down menu to Custom filter list and manually enter ScreenFreezedBuffer in the List (one value per line) box. Click the Apply button to filter on this value.

6. QuickSight will now render a chart showing the number of buffer events experienced, grouped by edge location.

### TIME TO FIRST FRAME BY LOCATION
This chart joins the time to first frame metric from the video.js plugin metrics with edge location information from the CloudFront CDN logs. You can use this chart to assess the user experience when starting playback of videos from different geographic locations.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    location -> X axis

    time_millisecond -> Value

    metrictype -> Group/Color

4. Click on the drop-down menu arrow next to time_millisecond in the green Value box and modify the Aggregate value to Average.

5. Click on the Filter menu and then click on the + icon located next to the Applied Filters heading. From the drop-down menu select metrictype to create a filter on the metric types recorded in the logs.

6. Click on the metrictype filter that is now in the filter list and from the list of metric types shown, tick the box next to FIRSTFRAME.

    If QuickSight does not show FIRSTFRAME as an available option to filter on, you can add it manually manually: modify the Filter type drop-down menu to Custom filter list and manually enter FIRSTFRAME in the List (one value per line) box. Click the Apply button to filter on this value.

7. QuickSight will now render a chart showing the average time to first frame for each edge location in the content distribution network.

### (OPTIONAL) ADDITIONAL CHARTS IF TIME ALLOWS
The following reports build on some of the techniques you have just explored. If you still have time left, please feel free to complete these, but if you are running short on time, we advise moving forward to the next lab so that you get the most out of the workshop.

### AVERAGE BITRATE BY VIDEO
This chart will show the average bitrate recorded for each video over time. You can use this report to identify videos which may not be meeting your users expectations in terms of bitrate and quality.

1. Click the "+ Add" button located in the top left corner of the QuickSight Analysis console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag video_id on to the blue X axis box located in the Field wells section at the top of the QuickSight console.

4. Next, click and drag avg_bitrate on to the green Value box located in the Field wells section.

5. Click on the drop-down menu arrow next to avg_bitrate in the green Value box and change the Aggregate setting to Average

6. QuickSight will now render a chart showing a list of videos on the X axis and the average streaming bitrate recorded by the video player metrics for each video.

### PLAYBACK ERRORS GROUPED BY VIDEO BY DAY
This chart will show any videos that have experienced playback errors. You can use this report to identify if there is content in your library which may have encoding problems or other issues with the video player application.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    video_id -> X axis

    metrictype -> Value

    eventtime -> Group/Color

4. Click on the Filter menu and then click on the + icon located next to the Applied Filters heading. From the drop-down menu select metrictype to create a filter on player events.

5. Click on the metrictype filter that is now in the filter list and from the list of event types, tick the box next to ERROR. If you do not see ERROR in the list, you may not have any ERROR events in your logs yet! To add ERROR manually, modify the Filter type drop-down menu to Custom filter list and manually enter ERROR in the List (one value per line) box. Push the Apply button to filter on this value.

6. QuickSight will now render a chart showing the number of errors reported for each video, grouped together by the day of the week.

8. (optional) To change the graph to break this down by the hour, click on the drop-down menu arrow next to eventtime in the blue X axis box located in the Field wells section at the top of the QuickSight console. Change the Aggregate option to Hour.

### BUFFERING EVENTS EXPERIENCED BY VIDEO
This chart will show a count of buffering events recorded for each video in the catalog. This chart can be used to identify if certain users are having problems viewing specific items in the catalog.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    video_id -> X axis

    buffer_type -> Value

    eventtime -> Group/Color

4. Click on the Filter menu and then click on the + icon located next to the Applied Filters heading. From the drop-down menu select buffer_type to create a filter on buffering event types.

5. Click on the buffer_type filter that is now in the filter list and from the list of buffer types shown, tick the box next to ScreenFreezedBuffer.

6. QuickSight will now render a chart showing the number of buffer events for each video for each day.

### BITRATE CHANGES UP AND DOWN
This chart shows the number of bitrate changes, both in an upward and downward direction. You can use this to understand if users are experiencing frequent changes in bitrate as they watch your content, which may mean there are opportunities to review your encoding profiles to better optimize the viewing experience.

1. Click the "+ Add" button located in the top left corner of the console and select Add Visual to create a new chart.

2. For this chart we will use a Vertical Stacked 100% Bar Chart. Select this chart type from the Visual types menu located in the bottom left corner of the QuickSight console.

3. From the Fields list menu on the left, click and drag the following fields to these locations:

    direction -> X axis

    video_id -> Group/Color

4. The chart that renders will likely show some values corresponding to NULL. Mouseover these values and after clicking, select Exclude Null from the menu that appears.

5. QuickSight will now render a chart showing the counts of changes in bitrate both up and down recorded by the video player application.


## [PROCEED TO LAB 3](LAB3.md)
Once you've built your QuickSight analysis of the key operational metrics, you can click on the following button to proceed to the next lab.

## [LAB 3: MEASURING AND REPORTING IN REAL TIME](LAB3.md)
   
Note: When a reasonable amount of participants get to this stage, we will continue with the presentation, introducing the component of the solution: Real-time analytics

If you're keen, it's perfectly fine to proceed - but it's recommended that you hit the above button and wait until the aforementioned content has been presented (we will commence presenting content when approximately 20-percent of participants have loaded the page for Lab 3).
